---
π“… **λ‚ μ§**: 2025λ…„ 3μ›” 18μΌ (ν™”)
π‘¤ **μ‘μ„±μ**: κ°•μ² μ› (μ—°κµ¬μ±…μ„μ) | **μΉμΈ**: κ°•νλ¦Ό (λ€ν‘)
π“ **μ§„ν–‰ λ‹¨κ³„**: 3λ‹¨κ³„ - κ³ λ„ν™” λ° μ‚¬μ—…ν™”
π― **μ£Όμ” μ‘μ—…**: λ°±μ—”λ“ κ²°μ  κ²€μ¦ λ° Webhook κµ¬ν„
---

# AI κΈ°λ° λ‹¤κµ­μ–΄ μμ„± ν•©μ„± λ° μ‹¤μ‹κ°„ λ¦½μ‹±ν¬ λ”λΉ™ μ‹μ¤ν… κ°λ°μΌμ§€

## π“‹ μ¤λμ μ‘μ—… λ‚΄μ©

### 1. κ²°μ  κ²€μ¦ (Verification)

- **λ©ν‘**: ν΄λΌμ΄μ–ΈνΈμ—μ„ μ΅°μ‘λ κΈμ•΅μΌλ΅ κ²°μ  μ”μ²­ν•λ” κ²ƒμ„ λ°©μ§€.
- **λ΅μ§**:
  1. ν΄λΌμ΄μ–ΈνΈκ°€ κ²°μ  ν›„ `imp_uid`λ¥Ό μ„λ²„λ΅ μ „μ†΅.
  2. μ„λ²„λ” `imp_uid`λ΅ PortOne APIλ¥Ό μ΅°νν•μ—¬ μ‹¤μ  κ²°μ  κΈμ•΅ ν™•μΈ.
  3. DBμ μ£Όλ¬Έ κΈμ•΅κ³Ό μΌμΉν•λ”μ§€ λ€μ΅°.

### 2. Webhook μ²λ¦¬

- **μ—­ν• **: λΉ„λ™κΈ° κ²°μ  κ²°κ³Ό μμ‹  (κ°€μƒκ³„μΆ μ…κΈ λ“±) λ° μ •κΈ° κ²°μ  μ„±κ³µ μ•λ¦Ό.
- **κµ¬ν„**: `/api/webhook/payment` μ—”λ“ν¬μΈνΈ μƒμ„±. μ„λ…(Signature) κ²€μ¦μΌλ΅ μ„μ΅° λ°©μ§€.

## π”§ κΈ°μ μ  μ§„ν–‰μ‚¬ν•­

### κ²€μ¦ μ½”λ“ (Python)

```python
def verify_payment(imp_uid, merchant_uid):
    token = get_admin_token()
    payment_data = requests.get(f"https://api.iamport.kr/payments/{imp_uid}", headers=...).json()
    
    order = db.query(Order).filter_by(id=merchant_uid).first()
    if payment_data['amount'] == order.amount:
        order.status = 'paid'
        user.credits += order.credits
        db.commit()
```

## π“ μ§„ν–‰ μƒν™©

| ν•­λ© | κ³„ν | μ‹¤μ  | μƒνƒ |
|------|------|------|------|
| κ²€μ¦ λ΅μ§ κµ¬ν„ | μ™„λ£ | μ™„λ£ | β… |
| Webhook κµ¬ν„ | μ™„λ£ | μ™„λ£ | β… |

## π§ μ΄μ μ‚¬ν•­ λ° ν•΄κ²° λ°©μ•

- **μ¤‘λ³µ μ²λ¦¬**: Webhookμ΄ μ—¬λ¬ λ² μ¬ μ μμ. -> `Idempotency Key`(λ©±λ“±μ„± ν‚¤) μ²λ¦¬λ΅ μ¤‘λ³µ μ λ¦½ λ°©μ§€.

## π“ λ‚΄μΌ κ³„ν

1. μ”κΈμ  UI κµ¬ν„ (Pricing Page)
2. κ²°μ  ν…μ¤νΈ (Sandbox ν™κ²½)

---

## π“ μ°Έκ³  μλ£

- [1] "Idempotency in API". [Link](https://stripe.com/docs/api/idempotent_requests)

<details>
<summary>IRIS λ¶™μ—¬λ„£κΈ°μ© HTML μ½”λ“</summary>

```html
<h3>1. κ²°μ  κ²€μ¦ (Verification)</h3>
<ul>
<li><strong>λ©ν‘</strong>: ν΄λΌμ΄μ–ΈνΈμ—μ„ μ΅°μ‘λ κΈμ•΅μΌλ΅ κ²°μ  μ”μ²­ν•λ” κ²ƒμ„ λ°©μ§€.</li>
<li><strong>λ΅μ§</strong>:
<ol>
<li>ν΄λΌμ΄μ–ΈνΈκ°€ κ²°μ  ν›„ <code>imp_uid</code>λ¥Ό μ„λ²„λ΅ μ „μ†΅.</li>
<li>μ„λ²„λ” <code>imp_uid</code>λ΅ PortOne APIλ¥Ό μ΅°νν•μ—¬ μ‹¤μ  κ²°μ  κΈμ•΅ ν™•μΈ.</li>
<li>DBμ μ£Όλ¬Έ κΈμ•΅κ³Ό μΌμΉν•λ”μ§€ λ€μ΅°.</li>
</ol>
</li>
</ul>
<h3>2. Webhook μ²λ¦¬</h3>
<ul>
<li><strong>μ—­ν• </strong>: λΉ„λ™κΈ° κ²°μ  κ²°κ³Ό μμ‹  (κ°€μƒκ³„μΆ μ…κΈ λ“±) λ° μ •κΈ° κ²°μ  μ„±κ³µ μ•λ¦Ό.</li>
<li><strong>κµ¬ν„</strong>: <code>/api/webhook/payment</code> μ—”λ“ν¬μΈνΈ μƒμ„±. μ„λ…(Signature) κ²€μ¦μΌλ΅ μ„μ΅° λ°©μ§€.</li>
</ul>
```

</details>
